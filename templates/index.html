<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Record</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen">

<div class="w-1/2">
    <textarea id="recordContent" class="w-full h-64 p-4 border border-gray-300 rounded resize-y"
              placeholder="Enter your record here..."></textarea>

    <div class="mt-4">
        <label class="block mb-2">Expiry time:</label>
        <div>
            <label>
                <input type="radio" name="expiry" value="1_hour" class="mr-2">
                1 Hour
            </label>
        </div>
        <div>
            <label>
                <input checked type="radio" name="expiry" value="1_day" class="mr-2">
                1 Day
            </label>
        </div>
        <div>
            <label>
                <input type="radio" name="expiry" value="1_week" class="mr-2">
                1 Week
            </label>
        </div>
    </div>

    <button id="shareBtn" class="mt-6 px-6 py-2 bg-blue-500 text-white rounded">Share</button>

    <div id="resultSection" class="mt-6 hidden">
        <textarea id="result" class="w-full h-32 p-4 border border-gray-300 rounded resize-none" readonly></textarea>
        <button id="createNewBtn" class="mt-4 px-6 py-2 bg-green-500 text-white rounded">Create New</button>
    </div>

    <div id="errorSection" class="mt-6 text-red-500 hidden">Error: Please fill all fields.</div>
</div>

<script>
    async function importPublicKey(pem) {
        const binaryDerString = window.atob(pem);
        const binaryDer = str2ab(binaryDerString);

        return window.crypto.subtle.importKey(
            "spki",
            binaryDer,
            {
                name: "RSA-OAEP",
                hash: "SHA-256"
            },
            true,
            ["encrypt"]
        );
    }

    function pemToBase64(pem) {
        return pem.replace(/-----BEGIN PUBLIC KEY-----/, '')
            .replace(/-----END PUBLIC KEY-----/, '')
            .replace(/\s+/g, '');
    }

    function str2ab(str) {
        const buf = new ArrayBuffer(str.length);
        const bufView = new Uint8Array(buf);
        for (let i = 0; i < str.length; i++) {
            bufView[i] = str.charCodeAt(i);
        }
        return buf;
    }

    function arrayBufferToBase64(buffer) {
        let binary = '';
        const bytes = new Uint8Array(buffer);
        for (let i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return window.btoa(binary);
    }

    document.getElementById('shareBtn').addEventListener('click', async () => {
        const content = document.getElementById('recordContent').value;
        const expiry = document.querySelector('input[name="expiry"]:checked')?.value;
        const errorSection = document.getElementById('errorSection');

        if (!content || !expiry) {
            errorSection.classList.remove('hidden');
            return;
        }

        errorSection.classList.add('hidden');

        const keysResponse = await fetch('/generate_keys');
        const {key_id, public_key} = await keysResponse.json();

        const publicKey = await importPublicKey(pemToBase64(public_key))
        const encryptedMessage = await window.crypto.subtle.encrypt({name: "RSA-OAEP"}, publicKey, new TextEncoder().encode(content))

        const saveResponse = await fetch('/save_record', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                encrypted_text: arrayBufferToBase64(encryptedMessage),
                key_id: key_id,
                expiry_option: expiry
            })
        });

        const {record_id, password} = await saveResponse.json();

        document.getElementById('resultSection').classList.remove('hidden');
        document.getElementById('result').value = `Record ID: http://localhost:8080/${record_id}\nPassword: ${password}`;
    });

    document.getElementById('createNewBtn').addEventListener('click', () => {
        location.reload();
    });
</script>
</body>
</html>
